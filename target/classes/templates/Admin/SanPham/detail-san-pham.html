<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="admin/fragments/head :: head"></head>
<body class="hold-transition skin-blue sidebar-mini">
<style>
    .image-wrapper {
        width: 60px;
        height: 100px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa; /* T√πy ch·ªçn: m√†u n·ªÅn n·∫øu ·∫£nh kh√¥ng l·∫•p ƒë·∫ßy khung */
    }

    .image-wrapper img {
        width: 100%;
        height: auto;
        object-fit: contain; /* Hi·ªÉn th·ªã to√†n b·ªô ·∫£nh m√† kh√¥ng b·ªã c·∫Øt */
    }

    .image-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        gap: 5px;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }

    .image-wrapper:hover .image-overlay {
        opacity: 1;
    }

    .image-overlay button {
        background: rgba(0, 0, 0, 0.5);
        color: white;
        border: none;
        padding: 5px;
        border-radius: 5px;
        cursor: pointer;
    }

    .image-overlay button:hover {
        background: rgba(0, 0, 0, 0.8);
    }
    .form-check-input:hover {
        transform: scale(1.1);
        cursor: pointer;
    }

</style>
<!-- Site wrapper -->
<div class="wrapper">

    <div th:replace="admin/fragments/header :: header"></div>
    <!-- =============================================== -->

    <!-- Left side column. contains the sidebar -->
    <div th:replace="admin/fragments/sidebar :: sidebar"></div>

    <!-- =============================================== -->
    <!--    ti√™u ƒë·ªÅ ch·ªØ-->
    <style>
        .content-header {
            background: linear-gradient(to right, #3a3f51, #2c2f3e);
            padding: 20px;
            border-radius: 12px 12px 0 0;
            margin-bottom: 20px;
            text-align: center;
        }

        .content-header h2 {
            color: white;
            font-weight: 700;
            margin: 0;
        }
    </style>
    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h2>üîç Chi ti·∫øt s·∫£n ph·∫©m</h2>
        </section>

        <!-- Main content -->
        <section class="content">

            <!-- Default box -->
            <div class="box">
                <div class="box-body">
                    <div class="container mt-5">
                        <h2 class="text-center fw-bold">Th√¥ng Tin S·∫£n Ph·∫©m</h2>

                        <div class="container mt-5 d-flex justify-content-center">
                            <div class="shadow p-4 rounded bg-light w-100">
                                <form id="updateForm">
                                    <input type="hidden" name="id" th:value="${sanPham.id}"/>

                                    <div class="text-center">
                                        <div class="mb-3 d-flex justify-content-center align-items-center">
                                            <span class="form-label fw-semibold me-3">T√™n s·∫£n ph·∫©m:</span>
                                            <input type="text" class="form-control" name="tenSanPham" id="tenSanPham"
                                                   style="max-width: 600px;" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m"
                                                   th:value="${sanPham.tenSanPham}">
                                        </div>
                                        <div class="mb-3 d-flex justify-content-center align-items-center">
                                            <span class="form-label fw-semibold me-3">M√¥ t·∫£:</span>
                                            <textarea class="form-control" name="moTa" id="moTa"
                                                      style="max-width: 600px;" rows="3"
                                                      placeholder="Nh·∫≠p m√¥ t·∫£ s·∫£n ph·∫©m"
                                                      th:text="${sanPham.moTa}" th:value="${sanPham.moTa}"></textarea>
                                        </div>
                                    </div>

                                    <div class="container">
                                        <div class="row justify-content-center g-4">
                                            <div class="col-md-5">
                                                <span class="form-label fw-semibold d-block mb-1">Danh M·ª•c:</span>
                                                <div class="d-flex">
                                                    <select class="form-select me-2" name="danhMucId" id="danhMuc">
                                                        <option value="">Ch·ªçn danh m·ª•c</option>
                                                        <option th:each="dm :${danhMuc}" th:value="${dm.id}"
                                                                th:text="${dm.tenDanhMuc}"
                                                                th:selected="${sanPham.danhMuc != null && sanPham.danhMuc.id == dm.id}">
                                                        </option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-5">
                                                <span class="form-label fw-semibold d-block mb-1">Th∆∞∆°ng Hi·ªáu:</span>
                                                <div class="d-flex">
                                                    <select class="form-select me-2" name="thuongHieuId"
                                                            id="thuongHieu">
                                                        <option th:value="null">Ch·ªçn th∆∞∆°ng hi·ªáu</option>
                                                        <option th:each="th :${thuongHieu}" th:value="${th.id}"
                                                                th:text="${th.tenThuongHieu}"
                                                                th:selected="${sanPham.thuongHieu != null && sanPham.thuongHieu.id == th.id}">
                                                        </option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row justify-content-center g-4 mt-1">
                                            <div class="col-md-5">
                                                <span class="form-label fw-semibold d-block mb-1">Ch·∫•t li·ªáu:</span>
                                                <div class="d-flex">
                                                    <select class="form-select me-2" name="chatLieuId" id="chatLieu">
                                                        <option value="">Ch·ªçn ch·∫•t li·ªáu</option>
                                                        <option th:each="cl :${chatLieu}" th:value="${cl.id}"
                                                                th:text="${cl.tenChatLieu}"
                                                                th:selected="${sanPham.chatLieu != null && sanPham.chatLieu.id == cl.id}">
                                                        </option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-5">
                                                <span class="form-label fw-semibold d-block mb-1">Xu·∫•t X·ª©:</span>
                                                <div class="d-flex">
                                                    <select class="form-select me-2" name="xuatXuId" id="xuatXu">
                                                        <option value="">Ch·ªçn xu·∫•t x·ª©</option>
                                                        <option th:each="xx :${xuatXu}" th:value="${xx.id}"
                                                                th:text="${xx.quocGia}"
                                                                th:selected="${sanPham.xuatXu != null && sanPham.xuatXu.id == xx.id}">
                                                        </option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- N√∫t c·∫≠p nh·∫≠t -->
                                    <div class="text-center mt-4">
                                        <button type="submit" class="btn btn-success fw-bold">
                                            <i class="bi bi-save"></i> C·∫≠p nh·∫≠t
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!--Danh s√°ch m√†u s·∫Øc v√† k√≠ch th∆∞·ªõc trong s·∫£n ph·∫©m-->
                        <div class="container mt-4 d-flex justify-content-center">
                            <div class="shadow p-4 rounded bg-light w-100">
                                <h4 class="text-uppercase fw-bold text-center">K√≠ch c·ª° v√† m√†u s·∫Øc</h4>
                                <form>
                                    <div class="row g-3">
                                        <!-- Ch·ªçn K√≠ch C·ª° -->
                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">K√≠ch C·ª°:</label>
                                            <div class="border rounded p-2 d-flex flex-wrap gap-2">
                                                <label th:each="kt : ${kichThuocSanPham}"
                                                       class="border rounded px-3 py-1">
                                                    <span th:text="${kt.tenKichThuoc}"></span>
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Ch·ªçn M√†u S·∫Øc -->
                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">M√†u S·∫Øc:</label>
                                            <div class="border rounded p-2 d-flex flex-wrap gap-2">
                                                <label th:each="ms : ${mauSacSanPham}" class="border rounded px-3 py-1">
                                                    <span th:text="${ms.tenMauSac}"
                                                          class="rounded border border-secondary shadow">
                                                    </span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- N√∫t m·ªü Modal -->
                                    <div class="text-center mt-3">
                                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal"
                                                data-bs-target="#kichThuocMauSacModal">
                                            Ch·ªçn k√≠ch c·ª° & m√†u s·∫Øc
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>


                        <!-- Modal ch·ªçn k√≠ch th∆∞·ªõc v√† m√†u s·∫Øc -->
                        <div class="modal fade" id="kichThuocMauSacModal" tabindex="-1"
                             aria-labelledby="kichThuocMauSacModalLabel"
                             aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <input type="hidden" id="sanPhamIdHidden" th:value="${sanPham.id}">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="kichThuocMauSacModalLabel">Ch·ªçn K√≠ch C·ª° & M√†u
                                            S·∫Øc</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <!-- K√≠ch Th∆∞·ªõc -->
                                        <h6 class="fw-bold">K√≠ch C·ª°</h6>
                                        <div class="d-flex flex-wrap gap-2 mb-3">
                                            <label th:each="kt : ${kichThuoc}" class="border rounded px-3 py-1">
                                                <input type="checkbox" name="kichThuocIds" class="kich-thuoc me-1"
                                                       th:value="${kt.id}"
                                                       th:attr="data-kich-thuoc=${kt.id}">
                                                <span th:text="${kt.tenKichThuoc}"></span>
                                            </label>
                                        </div>


                                        <!-- M√†u S·∫Øc -->
                                        <h6 class="fw-bold">M√†u S·∫Øc</h6>
                                        <div class="d-flex flex-wrap gap-2">
                                            <label th:each="ms : ${mauSac}"
                                                   class="border rounded px-2 py-1 d-flex align-items-center">
                                                <input type="checkbox" name="mauSacIds" class="mau-sac me-2"
                                                       th:value="${ms.id}"
                                                       th:attr="data-mau-sac=${ms.id}">
                                                <div th:text="${ms.tenMauSac}"
                                                     class="rounded border border-secondary shadow"></div>
                                            </label>
                                        </div>

                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng
                                        </button>

                                        <button id="saveSelection" class="btn btn-primary">
                                            <input type="hidden" name="sanPhamId" th:value="${sanPham.id}">
                                            L∆∞u
                                        </button>

                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="container mt-4 d-flex justify-content-center">
                            <div class="shadow p-4 rounded bg-light w-100">
                                <h4 class="text-uppercase fw-bold text-center">Chi ti·∫øt s·∫£n ph·∫©m</h4>
                                <div class="d-flex flex-row-reverse bd-highlight">
                                    <button id="saveDetailProduct" class="btn btn-primary">L∆∞u chi ti·∫øt s·∫£n ph·∫©m
                                    </button>
                                </div>

                                <table id="productTable"
                                       class="table table-striped table-bordered text-center">
                                    <thead class="table-dark">
                                    <tr>
                                        <th style="width: 5%" class="text-center"></th>
                                        <th style="width: 15%" class="text-center">T√™n S·∫£n Ph·∫©m</th>
                                        <th style="width: 10%" class="text-center">S·ªë l∆∞·ª£ng</th>
                                        <th style="width: 15%" class="text-center">Gi√° B√°n</th>
                                        <th style="width: 10%" class="text-center">Tr·∫°ng Th√°i</th>
                                        <th style="width: 15%" class="text-center">H√†nh ƒë·ªông</th>
                                        <th style="width: 40%" class="text-center">Upload ·∫¢nh</th>
                                    </tr>
                                    </thead>
                                    <tbody class="text-center">
                                    <tr th:each="chiTiet, iterStat : ${sanPhamChiTiet}">
                                        <td class="text-center align-middle">
                                            <div class="form-check d-flex justify-content-center align-items-center">
                                                <input class="form-check-input" type="checkbox" th:value="${chiTiet.id}"
                                                       id="checkbox-[[${chiTiet.id}]]">
                                                <label class="ms-2 fw-bold" for="checkbox-[[${chiTiet.id}]]"
                                                       th:text="${iterStat.index + 1}"></label>
                                            </div>
                                        </td>
                                        <td th:text="${chiTiet.sanPham.tenSanPham} + ' [' + ${chiTiet.kichThuoc.tenKichThuoc} + ' - ' + ${chiTiet.mauSac.tenMauSac} + ' ]'"></td>
                                        <td>
                                            <input type="hidden" th:value="${chiTiet.id}" class="spct-id">
                                            <input type="number" class="form-control spct-soLuong" name="number"
                                                   th:value="${chiTiet.soLuong}" min="1" step="1"
                                                   oninput="checkForm(this)">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control spct-gia" name="price"
                                                   th:value="${chiTiet.gia != null ? #numbers.formatInteger(chiTiet.gia, 3, 'COMMA') + ' VND' : '0 VND'}"
                                                   oninput="checkForm(this)">
                                        </td>
                                        <td>
                                            <button th:value="${chiTiet.id}"
                                                    th:class=" ${chiTiet.trangThai == 'C√≤n H√†ng' ? 'badge bg-success ' : 'badge bg-danger '} "
                                                    th:text="${chiTiet.trangThai}">
                                            </button>

                                        </td>
                                        <td>
                                            <button class="btn btn-success btn-update" th:attr="data-id=${chiTiet.id}"
                                                    onclick="updateProduct(this)" disabled>
                                                <i class="bi bi-pencil-square"></i>
                                            </button>
                                            <button class="btn btn-danger" th:attr="data-id=${chiTiet.id}"
                                                    onclick="deleteProduct(this)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                            <button class="btn btn-info" th:attr="data-id=${chiTiet.id}"
                                                    onclick="viewProductDetail(this)">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-wrap gap-2 image-container">
                                                <th:block th:each="hinhAnh : ${chiTiet.hinhAnh}">
                                                    <div class="image-wrapper position-relative">
                                                        <img th:src="${hinhAnh.urlHinhAnh}" class="img-thumbnail"
                                                             width="60" height="60">

                                                        <!-- Overlay icons -->
                                                        <div class="image-overlay">
                                                            <button type="button"
                                                                    class="btn btn-sm btn-outline-light view-image"
                                                                    th:data-url="${hinhAnh.urlHinhAnh}">
                                                                <i class="bi bi-eye"></i>
                                                            </button>
                                                            <button type="button"
                                                                    class="btn btn-sm btn-outline-light delete-image"
                                                                    th:data-id="${hinhAnh.id}">
                                                                <i class="bi bi-trash"></i>
                                                            </button>

                                                        </div>
                                                    </div>
                                                </th:block>

                                                <div class="d-flex justify-content-center">
                                                    <label class="btn btn-light btn-sm d-flex align-items-center justify-content-center border border-secondary border-dashed rounded p-3"
                                                           style="width: 60px; height: 60px;">
                                                        <input type="file" class="file-input" hidden multiple>
                                                        +
                                                    </label>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>

                                <!-- Modal hi·ªÉn th·ªã chi ti·∫øt s·∫£n ph·∫©m -->
                                <div class="modal fade" id="productDetailModal" tabindex="-1"
                                     aria-labelledby="productDetailModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-xl"> <!-- Th√™m class modal-lg ƒë·ªÉ modal l·ªõn h∆°n -->
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div id="productDetailContent">ƒêang t·∫£i...</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.box -->

        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->

    <div th:replace="admin/fragments/footer :: footer"></div>


</div>
<!-- ./wrapper -->

<!-- jQuery 3 -->

<div th:replace="admin/fragments/script :: script"></div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Upload ·∫£nh khi ch·ªçn file
        document.addEventListener("change", function (event) {
            if (event.target.classList.contains("file-input")) {
                let input = event.target;
                let closestRow = input.closest("tr");
                let spctIdElement = closestRow.querySelector(".spct-id");

                if (!spctIdElement) {
                    Swal.fire("L·ªói!", "Kh√¥ng t√¨m th·∫•y ID s·∫£n ph·∫©m!", "error");
                    return;
                }

                let spctId = spctIdElement.value;
                let imgContainer = closestRow.querySelector(".d-flex");
                let files = input.files;
                if (files.length === 0) return;

                let formData = new FormData();
                for (let file of files) {
                    formData.append("files", file);
                }

                Swal.fire({
                    title: "ƒêang t·∫£i ·∫£nh l√™n...",
                    text: "Vui l√≤ng ch·ªù!",
                    icon: "info",
                    showConfirmButton: false,
                    allowOutsideClick: false
                });

                fetch(`/api/san-pham/upload/${spctId}`, { method: "POST", body: formData })
                    .then(response => {
                        if (!response.ok) throw new Error("L·ªói t·ª´ server!");
                        return response.json();
                    })
                    .then(imageUrls => {
                        let uploadButton = imgContainer.querySelector("label.btn-light");
                        imageUrls.forEach(url => {
                            let imgWrapper = document.createElement("div");
                            imgWrapper.classList.add("image-wrapper", "position-relative");
                            imgWrapper.innerHTML = `
                            <img src="${url}" class="img-thumbnail" width="60" height="60">
                            <div class="image-overlay">
                                <button type="button" class="btn btn-sm btn-outline-light view-image" data-url="${url}">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-light delete-image" data-url="${url}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        `;

                            if (uploadButton) {
                                imgContainer.insertBefore(imgWrapper, uploadButton);
                            } else {
                                imgContainer.appendChild(imgWrapper);
                            }
                        });

                        Swal.fire("Th√†nh c√¥ng!", "Upload ·∫£nh th√†nh c√¥ng!", "success");
                        setTimeout(() => location.reload(), 1000);
                    })
                    .catch(error => {
                        Swal.fire("L·ªói!", "Upload th·∫•t b·∫°i!", "error");
                    });
            }
        });

        // X·ª≠ l√Ω s·ª± ki·ªán x√≥a ·∫£nh
        document.addEventListener("click", function (event) {
            if (event.target.closest(".delete-image")) {
                let button = event.target.closest(".delete-image");
                let imageId = button.getAttribute("data-id");

                if (!imageId) {
                    Swal.fire("L·ªói!", "Kh√¥ng t√¨m th·∫•y ID ·∫£nh!", "error");
                    return;
                }

                let wrapper = button.closest(".image-wrapper");

                Swal.fire({
                    title: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ·∫£nh n√†y?",
                    text: "H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "C√≥, x√≥a ngay!",
                    cancelButtonText: "H·ªßy",
                    confirmButtonColor: "#d33",
                    cancelButtonColor: "#3085d6"
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            title: "ƒêang x√≥a ·∫£nh...",
                            text: "Vui l√≤ng ch·ªù!",
                            icon: "info",
                            showConfirmButton: false,
                            allowOutsideClick: false
                        });

                        fetch(`/api/san-pham/xoa/${imageId}`, { method: "DELETE" })
                            .then(response => {
                                if (!response.ok) throw new Error("X√≥a ·∫£nh th·∫•t b·∫°i!");
                                return response.text();
                            })
                            .then(() => {
                                wrapper.remove();
                                Swal.fire("Th√†nh c√¥ng!", "·∫¢nh ƒë√£ ƒë∆∞·ª£c x√≥a!", "success");
                            })
                            .catch(error => {
                                console.error("L·ªói x√≥a ·∫£nh:", error);
                                Swal.fire("L·ªói!", "X√≥a ·∫£nh th·∫•t b·∫°i!", "error");
                            });
                    }
                });
            }
        });

        // X·ª≠ l√Ω s·ª± ki·ªán xem ·∫£nh
        document.addEventListener("click", function (event) {
            if (event.target.closest(".view-image")) {
                let button = event.target.closest(".view-image");
                let imageUrl = button.getAttribute("data-url");

                if (!imageUrl) {
                    Swal.fire("L·ªói!", "Kh√¥ng t√¨m th·∫•y ·∫£nh!", "error");
                    return;
                }

                Swal.fire({
                    title: "Xem ·∫£nh",
                    imageUrl: imageUrl,
                    imageAlt: "H√¨nh ·∫£nh",
                    showCloseButton: true
                });
            }
        });
    });
</script>
<script>
    $(document).ready(function () {
        $("#saveDetailProduct").click(function () {
            let selectedData = [];
            let isAnySelected = false;

            $("#productTable tbody tr").each(function () {
                let $row = $(this);
                let checkbox = $row.find("td:first-child input[type='checkbox']");

                if (checkbox.is(":checked")) {
                    isAnySelected = true;

                    let soLuong = $row.find(".spct-soLuong").val().replace(/[^\d]/g, '');
                    let gia = $row.find(".spct-gia").val().replace(/[^\d]/g, '');

                    let item = {
                        id: parseInt($row.find(".spct-id").val()),
                        soLuong: parseInt(soLuong),
                        gia: parseFloat(gia)
                    };
                    selectedData.push(item);
                }
            });

            if (!isAnySelected) {
                Swal.fire({
                    title: "L·ªói",
                    text: "Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m.",
                    icon: "warning",
                    confirmButtonText: "OK"
                });
                return;
            }

            fetch('/api/san-pham/update-product-details', {
                method: 'PUT',
                body: JSON.stringify(selectedData),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(async response => {
                const data = await response.json();
                const isWarning = data.status === "warning";
                const isError = data.status === "error" || !response.ok;

                if (data.status === "success") {
                    Swal.fire({
                        title: "Th√†nh c√¥ng!",
                        text: data.message || "C·∫≠p nh·∫≠t th√†nh c√¥ng!",
                        icon: "success",
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => window.location.reload());
                } else {
                    Swal.fire({
                        title: isWarning ? "C·∫£nh b√°o!" : "L·ªói!",
                        text: data.message || "ƒê√£ x·∫£y ra l·ªói.",
                        icon: isWarning ? "warning" : "error",
                        confirmButtonText: "OK"
                    });
                }
            })
            .catch(error => {
                console.error("L·ªói c·∫≠p nh·∫≠t:", error);
                Swal.fire({
                    title: "Th·∫•t b·∫°i!",
                    text: error.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh!",
                    icon: "error",
                    confirmButtonText: "OK"
                });
            });
        });
    });
</script>

<script>
    function viewProductDetail(button) {
        let productId = button.getAttribute("data-id");
        let url = `/admin/san-pham-chi-tiet?sanPhamChiTietId=` + productId;
        let modalContent = document.getElementById("productDetailContent");

        // Hi·ªÉn th·ªã loading tr∆∞·ªõc khi t·∫£i d·ªØ li·ªáu
        modalContent.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary" role="status"></div></div>';

        fetch(url)
            .then(response => response.text())
            .then(html => {
                modalContent.innerHTML = html;
            })
            .catch(error => {
                console.error("L·ªói khi t·∫£i chi ti·∫øt s·∫£n ph·∫©m:", error);
                modalContent.innerHTML = "<p class='text-danger'>Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu.</p>";
            });

        new bootstrap.Modal(document.getElementById("productDetailModal")).show();
    }
</script>

<script>
    document.getElementById("updateForm").addEventListener("submit", function (event) {
        event.preventDefault(); // NgƒÉn ch·∫∑n load l·∫°i trang

        let formData = new FormData(this);
        let requestBody = Object.fromEntries(formData);

        // X·ª≠ l√Ω gi√° ti·ªÅn n·∫øu c√≥ ƒë∆°n v·ªã VND
        if (requestBody.gia) {
            requestBody.gia = requestBody.gia.replace(/\D/g, ""); // Ch·ªâ gi·ªØ l·∫°i s·ªë
        }

        fetch('/api/san-pham/update-san-pham/' + formData.get("id"), {
            method: 'PUT',
            body: JSON.stringify(requestBody),
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200) {
                    Swal.fire({
                        title: "Th√†nh c√¥ng!",
                        text: "C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng!",
                        icon: "success",
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => window.location.reload()); // T·∫£i l·∫°i trang sau khi ho√†n th√†nh
                } else {
                    let errorMessage = body.message || body.error || "C√≥ l·ªói x·∫£y ra!";
                    switch (status) {
                        case 400:
                            errorMessage = "L·ªói d·ªØ li·ªáu! " + errorMessage;
                            break;
                        case 409:
                            errorMessage = "Xung ƒë·ªôt d·ªØ li·ªáu! " + errorMessage;
                            break;
                        case 500:
                            errorMessage = "L·ªói h·ªá th·ªëng! " + errorMessage;
                            break;
                    }
                    throw new Error(errorMessage);
                }
            })
            .catch(error => {
                console.error("L·ªói c·∫≠p nh·∫≠t:", error);

                // Ph√¢n bi·ªát l·ªói nh·∫π v√† n·∫∑ng ƒë·ªÉ hi·ªÉn th·ªã c·∫£nh b√°o ph√π h·ª£p
                const msg = error.message.toLowerCase();
                const isDanger =
                    msg.includes("l·ªói h·ªá th·ªëng") ||
                    msg.includes("exception") ||
                    msg.includes("kh√¥ng th·ªÉ") ||
                    msg.includes("ƒë√£ x·∫£y ra") ||
                    msg.includes("internal");

                Swal.fire({
                    title: isDanger ? "L·ªói!" : "C·∫£nh b√°o!",
                    text: error.message,
                    icon: isDanger ? "error" : "warning",
                    confirmButtonText: "OK"
                });
            });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let saveBtn = document.getElementById("saveSelection");
        if (saveBtn) {
            saveBtn.addEventListener("click", function () {
                const urlParams = new URLSearchParams(window.location.search);
                const sanPhamId = urlParams.get("sanPhamId");

                if (!sanPhamId) {
                    Swal.fire({
                        title: "L·ªói!",
                        text: "Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m. Vui l√≤ng ki·ªÉm tra l·∫°i URL.",
                        icon: "error",
                        confirmButtonText: "OK"
                    });
                    return;
                }

                let selectedMauSac = [...document.querySelectorAll("input[name='mauSacIds']:checked")].map(el => el.value);
                let selectedKichThuoc = [...document.querySelectorAll("input[name='kichThuocIds']:checked")].map(el => el.value);

                if (selectedMauSac.length === 0 || selectedKichThuoc.length === 0) {
                    Swal.fire({
                        title: "C·∫£nh b√°o!",
                        text: "Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt k√≠ch th∆∞·ªõc v√† m·ªôt m√†u s·∫Øc.",
                        icon: "warning",
                        confirmButtonText: "OK"
                    });
                    return;
                }

                fetch("/api/san-pham/add-mau-sac-kich-thuoc", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        sanPhamId: sanPhamId,
                        mauSacIds: selectedMauSac,
                        kichThuocIds: selectedKichThuoc
                    })
                })
                    .then(response => response.text().then(data => ({ status: response.status, body: data })))
                    .then(({ status, body }) => {
                        if (status === 200) {
                            Swal.fire({
                                title: "Th√†nh c√¥ng!",
                                text: "Th√™m th√†nh c√¥ng!",
                                icon: "success",
                                timer: 1500,
                                showConfirmButton: false
                            }).then(() => window.location.reload());
                        } else {
                            throw new Error(body || "C√≥ l·ªói x·∫£y ra!");
                        }
                    })
                    .catch(error => {
                        console.error("L·ªói:", error);
                        Swal.fire({
                            title: "L·ªói!",
                            text: error.message,
                            icon: "error",
                            confirmButtonText: "OK"
                        });
                    });
            });
        } else {
            console.error("Kh√¥ng t√¨m th·∫•y n√∫t #saveSelection");
        }
    });
</script>

<script>
    function checkForm(input) {
        let row = input.closest("tr");
        let soLuong = row.querySelector(".spct-soLuong").value.replace(/\./g, "").trim();
        let gia = row.querySelector(".spct-gia").value.replace(/\./g, "").trim();
        let updateButton = row.querySelector(".btn-update");

        if (soLuong !== "" && gia !== "") {
            updateButton.removeAttribute("disabled");
        } else {
            updateButton.setAttribute("disabled", "disabled");
        }
    }

  function updateProduct(button) {
    let row = button.closest("tr");
    let soLuongInput = row.querySelector(".spct-soLuong");
    let giaInput = row.querySelector(".spct-gia");

    let soLuong = soLuongInput.value.replace(/\D/g, "").trim(); // Lo·∫°i b·ªè t·∫•t c·∫£ k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
    let gia = giaInput.value.replace(/\D/g, "").trim(); // Lo·∫°i b·ªè t·∫•t c·∫£ k√Ω t·ª± kh√¥ng ph·∫£i s·ªë

    if (soLuong === "" || gia === "") {
        Swal.fire({
            title: "C·∫£nh b√°o!",
            text: "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!",
            icon: "warning",
            confirmButtonText: "OK"
        });
        return;
    }

    let id = button.getAttribute("data-id");

    fetch("/api/san-pham/update", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: id, soLuong: soLuong, gia: gia })
    })
    .then(response => response.json()) // Chuy·ªÉn th√†nh JSON ƒë·ªÉ d√πng body.status
    .then(data => {
        if (data.status === "success") {
            Swal.fire({
                title: "Th√†nh c√¥ng!",
                text: data.message,
                icon: "success",
                timer: 1500,
                showConfirmButton: false
            }).then(() => location.reload());
        } else if (data.status === "warning") {
            Swal.fire({
                title: "C·∫£nh b√°o!",
                text: data.message,
                icon: "warning",
                confirmButtonText: "OK"
            });
        } else {
            Swal.fire({
                title: "L·ªói!",
                text: data.message,
                icon: "error",
                confirmButtonText: "OK"
            });
        }
    })
    .catch(error => {
        console.error("L·ªói c·∫≠p nh·∫≠t:", error);
        Swal.fire({
            title: "L·ªói k·∫øt n·ªëi!",
            text: "Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.",
            icon: "error",
            confirmButtonText: "OK"
        });
    });
}
    function deleteProduct(button) {
        let id = button.getAttribute("data-id");

        Swal.fire({
            title: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?",
            text: "H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "C√≥, x√≥a ngay!",
            cancelButtonText: "H·ªßy",
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6"
        }).then((result) => {
            if (result.isConfirmed) {
                fetch("/api/san-pham/delete/" + encodeURIComponent(id), {
                    method: "DELETE"
                })
                    .then(response => response.text().then(data => ({ status: response.status, body: data })))
                    .then(({ status, body }) => {
                        if (status === 200) {
                            Swal.fire({
                                title: "ƒê√£ x√≥a!",
                                text: "S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng.",
                                icon: "success",
                                timer: 1500,
                                showConfirmButton: false
                            }).then(() => location.reload());
                        } else {
                            throw new Error(body || "X√≥a th·∫•t b·∫°i!");
                        }
                    })
                    .catch(error => {
                        console.error("L·ªói x√≥a s·∫£n ph·∫©m:", error);
                        const isDanger = isSeriousError(error.message);
                        Swal.fire({
                            title: isDanger ? "L·ªói!" : "C·∫£nh b√°o!",
                            text: error.message,
                            icon: isDanger ? "error" : "warning",
                            confirmButtonText: "OK"
                        });
                    });
            }
        });
    }

    function isSeriousError(message) {
        const msg = message.toLowerCase();
        return (
            msg.includes("l·ªói h·ªá th·ªëng") ||
            msg.includes("exception") ||
            msg.includes("kh√¥ng th·ªÉ") ||
            msg.includes("ƒë√£ x·∫£y ra") ||
            msg.includes("internal") ||
            msg.includes("500")
        );
    }
</script>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        let sanPhamChiTietList = /*[[${sanPhamChiTiet}]]*/ [];

        // T·∫°o danh s√°ch c√°c k√≠ch th∆∞·ªõc theo t·ª´ng m√†u
        let kichThuocTheoMau = {};
        sanPhamChiTietList.forEach(spct => {
            let mauId = spct.mauSac.id;
            let kichThuocId = spct.kichThuoc.id;

            if (!kichThuocTheoMau[kichThuocId]) {
                kichThuocTheoMau[kichThuocId] = new Set();
            }
            kichThuocTheoMau[kichThuocId].add(mauId);
        });

        // L·∫•y danh s√°ch t·∫•t c·∫£ c√°c m√†u s·∫Øc c√≥ trong h·ªá th·ªëng
        let allMauSac = new Set();
        document.querySelectorAll('.mau-sac').forEach(mau => {
            allMauSac.add(parseInt(mau.value));
        });

        // Disable k√≠ch th∆∞·ªõc n·∫øu n√≥ ƒë√£ t·ªìn t·∫°i v·ªõi t·∫•t c·∫£ m√†u
        function updateDisabledSizes() {
            document.querySelectorAll('.kich-thuoc').forEach(kichThuoc => {
                let kichThuocId = parseInt(kichThuoc.value);
                let colorsOfThisSize = kichThuocTheoMau[kichThuocId] || new Set();

                kichThuoc.disabled = colorsOfThisSize.size === allMauSac.size;
            });
        }

        updateDisabledSizes(); // G·ªçi l·∫ßn ƒë·∫ßu ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i

        // Ki·ªÉm tra h·ª£p l·ªá s·ªë l∆∞·ª£ng v√† gi√°
        function checkValidQuantityAndPrice() {
            let isValid = true;

            document.querySelectorAll('.spct-soLuong').forEach(input => {
                let quantity = parseInt(input.value);
                if (quantity <= 0) {
                    isValid = false;
                    alert("S·ªë l∆∞·ª£ng kh√¥ng th·ªÉ nh·ªè h∆°n ho·∫∑c b·∫±ng 0.");
                    input.focus();
                    return;
                }
            });

            document.querySelectorAll('.spct-gia').forEach(input => {
                let price = parseFloat(input.value.replace(' VND', '').replace(',', ''));
                if (price <= 0) {
                    isValid = false;
                    alert("Gi√° kh√¥ng th·ªÉ nh·ªè h∆°n ho·∫∑c b·∫±ng 0.");
                    input.focus();
                    return;
                }
            });

            return isValid;
        }

        // Khi ch·ªçn k√≠ch th∆∞·ªõc, ki·ªÉm tra m√†u s·∫Øc n√†o ƒë√£ t·ªìn t·∫°i
        function updateDisabledColors() {
            let selectedSizes = new Set();
            document.querySelectorAll('.kich-thuoc:checked').forEach(kichThuoc => {
                let kichThuocId = parseInt(kichThuoc.value);
                selectedSizes.add(kichThuocId);
            });

            // Reset tr·∫°ng th√°i t·∫•t c·∫£ m√†u
            document.querySelectorAll('.mau-sac').forEach(mau => {
                mau.disabled = false;
            });

            // N·∫øu c√≥ k√≠ch th∆∞·ªõc ƒë∆∞·ª£c ch·ªçn, ki·ªÉm tra m√†u s·∫Øc c·∫ßn disable
            if (selectedSizes.size > 0) {
                selectedSizes.forEach(kichThuocId => {
                    let colorsOfThisSize = kichThuocTheoMau[kichThuocId] || new Set();
                    document.querySelectorAll('.mau-sac').forEach(mau => {
                        let mauId = parseInt(mau.value);
                        if (colorsOfThisSize.has(mauId)) {
                            mau.disabled = true;
                        }
                    });
                });
            }

            // Ki·ªÉm tra t√≠nh h·ª£p l·ªá c·ªßa s·ªë l∆∞·ª£ng v√† gi√° khi thay ƒë·ªïi k√≠ch th∆∞·ªõc
            if (!checkValidQuantityAndPrice()) {
                return; // D·ª´ng x·ª≠ l√Ω n·∫øu c√≥ l·ªói
            }
        }

        document.querySelectorAll('.kich-thuoc').forEach(kichThuoc => {
            kichThuoc.addEventListener("change", function () {
                updateDisabledColors();
            });
        });
    });
</script>

<!--Load table-->
<script>
    $(document).ready(function () {
        $('#productTable').DataTable({
            "paging": true,
            "lengthMenu": [3, 5, 7, 10, 20],
            "pageLength": 5,
            "autoWidth": false,
            "responsive": true,
            "language": {
                "sProcessing": "ƒêang x·ª≠ l√Ω...",
                "sLengthMenu": "Hi·ªÉn th·ªã _MENU_ d√≤ng",
                "sZeroRecords": "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu",
                "sInfo": "Hi·ªÉn th·ªã _START_ ƒë·∫øn _END_ trong t·ªïng _TOTAL_ d√≤ng",
                "sInfoEmpty": "Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã",
                "sInfoFiltered": "(l·ªçc t·ª´ _MAX_ d√≤ng)",
                "sSearch": "T√¨m ki·∫øm:",
                "oPaginate": {
                    "sFirst": "ƒê·∫ßu",
                    "sPrevious": "Tr∆∞·ªõc",
                    "sNext": "Ti·∫øp",
                    "sLast": "Cu·ªëi"
                }
            }
        });
    });
</script>
<script src="/js/main.js"></script>
<script src="/js/DangNhap/login.js"></script>
<script src="/js/DangNhap/logout.js"></script>
</body>
</html>
