<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="admin/fragments/head :: head"></head>
<body class="hold-transition skin-blue sidebar-mini">
<!-- Site wrapper -->
<div class="wrapper">

    <div th:replace="admin/fragments/header :: header"></div>
    <!-- =============================================== -->

    <!-- Left side column. contains the sidebar -->
    <div th:replace="admin/fragments/sidebar :: sidebar"></div>

    <!-- =============================================== -->
    <!--    ti√™u ƒë·ªÅ ch·ªØ-->
    <style>
        .content-header {
            background: linear-gradient(to right, #3a3f51, #2c2f3e);
            padding: 20px;
            border-radius: 12px 12px 0 0;
            margin-bottom: 20px;
            text-align: center;
        }

        .content-header h2 {
            color: white;
            font-weight: 700;
            margin: 0;
        }
    </style>
    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h2>üì¶ S·∫£n ph·∫©m</h2>
        </section>

        <!-- Main content -->
        <section class="content">

            <!-- Default box -->
            <div class="box">
                <div class="box-body">
                    <section class="content">
                        <div class="box-body">
                            <div class="d-flex justify-content-center gap-3 mb-3 p-3 border rounded-3 shadow-sm bg-light">
                                <button class="btn btn-outline-primary filter-btn px-4 py-2 fw-bold border border-primary rounded-pill" data-status="">
                                    T·∫•t C·∫£ (<span id="count-all">0</span>)
                                </button>
                                <button class="btn btn-outline-success filter-btn px-4 py-2 fw-bold border border-success rounded-pill" data-status="ƒêang Ho·∫°t ƒê·ªông">
                                    ƒêang Ho·∫°t ƒê·ªông (<span id="count-active">0</span>)
                                </button>
                                <button class="btn btn-outline-danger filter-btn px-4 py-2 fw-bold border border-danger rounded-pill" data-status="Ng·ª´ng Ho·∫°t ƒê·ªông">
                                    Ng·ª´ng Ho·∫°t ƒê·ªông (<span id="count-inactive">0</span>)
                                </button>
                            </div>

                            <div class="d-flex justify-content-end mb-3">
                                <form th:action="@{/admin/add-san-pham}" method="get">
                                    <button type="submit" class="btn btn-success fw-bold">
                                        <i class="bi bi-plus-lg"></i> Th√™m S·∫£n Ph·∫©m
                                    </button>
                                </form>

                            </div>

                            <table id="productTable" class="table table-striped table-bordered">
                                <thead class="table-dark">
                                <tr class="text-center">
                                    <th>#</th>
                                    <th>M√£ S·∫£n Ph·∫©m</th>
                                    <th>T√™n S·∫£n Ph·∫©m</th>
                                    <th>S·ªë L∆∞·ª£ng</th>
                                    <th>Tr·∫°ng Th√°i</th>
                                    <th>Action</th>
                                </tr>
                                </thead>
                                <tbody class="text-center">
                                <tr th:each="sanPham, i : ${sanPham}" class="text-center">
                                    <td th:text="${i.index + 1}"></td>
                                    <td th:text="${sanPham.maSanPham}"></td>
                                    <td th:text="${sanPham.tenSanPham}"></td>
                                    <td class="fw-bold text-danger" th:text="${#numbers.formatInteger(sanPham.soLuong, 0, 'DEFAULT') ?: 0}"></td>
                                    <td>
                                        <button class="badge" th:classappend="${sanPham.trangThai == 'ƒêang Ho·∫°t ƒê·ªông'} ? 'bg-success' : 'bg-danger'"
                                                th:attr="data-id=${sanPham.id}">
                                            <span th:text="${sanPham.trangThai}"></span>
                                        </button>
                                    </td>
                                    <td>
                                        <a th:href="@{/admin/detail-san-pham(sanPhamId=${sanPham.id})}" class="btn btn-primary btn-sm fw-bold me-2">
                                            <i class="bi bi-eye"></i> Chi Ti·∫øt
                                        </a>
                                    </td>
                                </tr>
                                </tbody>
                            </table>

                        </div>
                    </section>
                </div>
            </div>
            <!-- /.box -->

        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->

    <div th:replace="admin/fragments/footer :: footer"></div>


</div>
<!-- ./wrapper -->

<!-- jQuery 3 -->

<div th:replace="admin/fragments/script :: script"></div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let table = $("#productTable").DataTable({
            "paging": true,
            "lengthMenu": [5, 10, 20],
            "pageLength": 5,
            "autoWidth": false,
            "responsive": true,
            "destroy": true,
            "language": {
                "sProcessing": "ƒêang x·ª≠ l√Ω...",
                "sLengthMenu": "Hi·ªÉn th·ªã _MENU_ d√≤ng",
                "sZeroRecords": "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu",
                "sInfo": "Hi·ªÉn th·ªã _START_ ƒë·∫øn _END_ trong t·ªïng _TOTAL_ d√≤ng",
                "sInfoEmpty": "Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã",
                "sInfoFiltered": "(l·ªçc t·ª´ _MAX_ d√≤ng)",
                "sSearch": "T√¨m ki·∫øm:",
                "oPaginate": {
                    "sFirst": "ƒê·∫ßu",
                    "sPrevious": "Tr∆∞·ªõc",
                    "sNext": "Ti·∫øp",
                    "sLast": "Cu·ªëi"
                }
            }
        });

        loadSanPham(""); // Load t·∫•t c·∫£ s·∫£n ph·∫©m ban ƒë·∫ßu
        loadCount();

        document.querySelectorAll(".filter-btn").forEach(button => {
            button.addEventListener("click", function () {
                let trangThai = this.getAttribute("data-status");
                loadSanPham(trangThai);
            });
        });

        function loadSanPham(trangThai) {
            fetch(`/api/san-pham/list?trangThai=${encodeURIComponent(trangThai)}`)
                .then(response => response.json())
                .then(data => {
                    table.clear().draw();

                    data.forEach((sanPham, index) => {
                        table.row.add([
                            index + 1,
                            sanPham.maSanPham,
                            sanPham.tenSanPham,
                            `<span class="fw-bold text-danger">${sanPham.soLuong != null ? sanPham.soLuong : 0}</span>`,
                            `<button class="badge ${sanPham.trangThai === 'ƒêang Ho·∫°t ƒê·ªông' ? 'bg-success' : 'bg-danger'} btn-status"
                     data-id="${sanPham.id}">
                    ${sanPham.trangThai}
                </button>`,
                            `<a href="/admin/detail-san-pham?sanPhamId=${sanPham.id}" class="btn btn-primary btn-sm fw-bold me-2">
                    <i class="bi bi-eye"></i> Chi Ti·∫øt
                </a>`
                        ]).draw(false);
                    });

                    document.querySelectorAll(".btn-status").forEach(button => {
                        button.addEventListener("click", function () {
                            const sanPhamId = this.getAttribute("data-id");

                            Swal.fire({
                                title: "X√°c nh·∫≠n thay ƒë·ªïi tr·∫°ng th√°i?",
                                text: "B·∫°n c√≥ ch·∫Øc mu·ªën c·∫≠p nh·∫≠t tr·∫°ng th√°i s·∫£n ph·∫©m n√†y?",
                                icon: "warning",
                                showCancelButton: true,
                                confirmButtonColor: "#3085d6",
                                cancelButtonColor: "#d33",
                                confirmButtonText: "C√≥, c·∫≠p nh·∫≠t!",
                                cancelButtonText: "H·ªßy"
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    fetch(`/api/san-pham/toggle-status/${sanPhamId}`, { method: "PUT" })
                                        .then(response => response.json()
                                            .then(data => ({
                                                status: response.status,
                                                message: data.error || data.message || "C√≥ l·ªói x·∫£y ra!"
                                            })))
                                        .then(({ status, message }) => {
                                            if (status === 200) {
                                                Swal.fire("Th√†nh c√¥ng!", "Tr·∫°ng th√°i s·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.", "success");
                                                loadSanPham(trangThai);
                                                loadCount();
                                            } else {
                                                Swal.fire("L·ªói!", message, "error");
                                            }
                                        })
                                        .catch(error => {
                                            Swal.fire("L·ªói h·ªá th·ªëng!", error.message, "error");
                                        });
                                }
                            });
                        });
                    });
                })
                .catch(error => console.error("L·ªói:", error));
        }

        function loadCount() {
            fetch("/api/san-pham/count")
                .then(response => response.json())
                .then(counts => {
                    document.getElementById("count-all").innerText = counts["T·∫•t C·∫£"];
                    document.getElementById("count-active").innerText = counts["ƒêang Ho·∫°t ƒê·ªông"];
                    document.getElementById("count-inactive").innerText = counts["Ng·ª´ng Ho·∫°t ƒê·ªông"];
                })
                .catch(error => console.error("L·ªói:", error));
        }
    });
</script>
<script src="/js/main.js"></script>
<script src="/js/DangNhap/login.js"></script>
<script src="/js/DangNhap/logout.js"></script>
</body>
</html>
