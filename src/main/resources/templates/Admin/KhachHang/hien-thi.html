<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="admin/fragments/head :: head"></head>
<body class="hold-transition skin-blue sidebar-mini">
<!-- Site wrapper -->
<div class="wrapper">

    <div th:replace="admin/fragments/header :: header"></div>
    <!-- =============================================== -->

    <!-- Left side column. contains the sidebar -->
    <div th:replace="admin/fragments/sidebar :: sidebar"></div>

    <!-- =============================================== -->
    <!--    ti√™u ƒë·ªÅ ch·ªØ-->
    <style>
        .content-header {
            background: linear-gradient(to right, #3a3f51, #2c2f3e);
            padding: 20px;
            border-radius: 12px 12px 0 0;
            margin-bottom: 20px;
            text-align: center;
        }

        .content-header h2 {
            color: white;
            font-weight: 700;
            margin: 0;
        }
    </style>
    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h2>üë§ Kh√°ch h√†ng</h2>
        </section>

        <!-- Main content -->
        <section class="content">

            <!-- Default box -->
            <div class="box">
                <div class="box-body">
                    <button class="btn btn-success mb-2" onclick="openModalForAdd()">Th√™m Kh√°ch H√†ng</button>

                    <table id="productTable" class="table table-striped table-bordered">
                        <thead class="table-dark">
                        <tr class="text-center">
                            <th class="text-center">#</th>
                            <th class="text-center">·∫¢nh</th>
                            <th class="text-center">T√™n Kh√°ch H√†ng</th>
                            <th class="text-center">S·ªë ƒêi·ªán Tho·∫°i</th>
                            <th class="text-center">Ng√†y Sinh</th>
                            <th class="text-center">Gi·ªõi T√≠nh</th>
                            <th class="text-center">Tr·∫°ng Th√°i</th>
                            <th class="text-center">Action</th>
                        </tr>
                        </thead>
                        <tbody id="khachHangBody">
                        <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JavaScript -->
                        </tbody>
                    </table>

                    <!-- Modal S·ª≠a Khach Hang -->
                    <div class="modal fade" id="modalUpdateKhachHang" tabindex="-1"
                         aria-labelledby="updateKhachHangLabel" aria-hidden="true">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title" id="updateKhachHangLabel"><i class="bi bi-person-plus"></i>
                                        Th√¥ng Tin Kh√°ch H√†ng</h5>
                                    <button type="button" class="btn-close text-white" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="updateKhachHangForm">
                                        <input type="hidden" name="id" id="khachHangId">
                                        <div class="row">
                                            <!-- C·ªôt 1: Avatar -->
                                            <div class="col-md-4 d-flex flex-column align-items-center justify-content-center">
                                                <img id="avatarPreview1" class="rounded-circle border shadow mb-3"
                                                     width="150" height="150" alt="·∫¢nh Nh√¢n Vi√™n">
                                                <input type="file" class="form-control mt-2" accept="image/*"
                                                       name="hinhAnh" onchange="previewImage(event)">
                                            </div>
                                            <!-- C·ªôt 2: Th√¥ng tin khach hang -->
                                            <div class="col-md-8">
                                                <div class="mb-3">
                                                    <label class="form-label"><i class="bi bi-person"></i> H·ªç
                                                        T√™n</label>
                                                    <input type="text" class="form-control" name="hoTen"
                                                           placeholder="Nh·∫≠p h·ªç t√™n" required>
                                                    <div id="error-hoTen" class="invalid-feedback"></div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label"><i class="bi bi-person-circle"></i>
                                                            Username</label>
                                                        <input type="text" class="form-control" name="username"
                                                               placeholder="Nh·∫≠p username" required>
                                                        <div id="error-username" class="invalid-feedback"></div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label"><i class="bi bi-key"></i> M·∫≠t
                                                            Kh·∫©u</label>
                                                        <input type="password" class="form-control" name="password"
                                                               placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required>
                                                        <div id="error-password" class="invalid-feedback"></div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label"><i class="bi bi-envelope"></i>
                                                            Email</label>
                                                        <input type="email" class="form-control" name="email"
                                                               placeholder="Nh·∫≠p email" required>
                                                        <div id="error-email" class="invalid-feedback"></div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label"><i class="bi bi-key"></i> So Dien Thoai</label>
                                                        <input type="text" class="form-control" name="soDienThoai"
                                                               placeholder="Nh·∫≠p so dien thoai" required>
                                                        <div id="error-soDienThoai" class="invalid-feedback"></div>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label"><i class="bi bi-house"></i> ƒê·ªãa
                                                        Ch·ªâ</label>
                                                    <input type="text" class="form-control" name="diaChi"
                                                           placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ" disabled>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label"><i class="bi bi-gender-ambiguous"></i>
                                                            Gi·ªõi T√≠nh</label>
                                                        <select class="form-select" name="gioiTinh">
                                                            <option value="true">Nam</option>
                                                            <option value="false">N·ªØ</option>
                                                        </select>
                                                        <div id="error-gioiTinh" class="invalid-feedback"></div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label"><i class="bi bi-calendar"></i> Ng√†y
                                                            Sinh</label>
                                                        <input type="date" class="form-control" name="ngaySinh">
                                                        <div id="error-ngaySinh" class="invalid-feedback"></div>

                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label"><i class="bi bi-toggle-on"></i> Tr·∫°ng Th√°i</label>
                                                    <select class="form-select" name="trangThai">
                                                        <option value="ƒêang Ho·∫°t ƒê·ªông">ƒêang Ho·∫°t ƒê·ªông</option>
                                                        <option value="Ng·ª´ng Ho·∫°t ƒê·ªông">Ng·ª´ng Ho·∫°t ƒê·ªông</option>
                                                    </select>

                                                    <div id="error-trangThai" class="invalid-feedback"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng
                                    </button>
                                    <button type="button" class="btn btn-primary" id="btnSave"
                                            onclick="saveKhachHang()">Luu
                                    </button>
                                    <button type="button" class="btn btn-primary" id="btnUpdate"
                                            onclick="updateKhachHang()">Cap Nhap
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Danh S√°ch ƒê·ªãa Ch·ªâ -->
                    <div class="modal fade" id="modalDiaChiKhachHang" tabindex="-1"
                         aria-labelledby="modalDiaChiKhachHangLabel" aria-hidden="true">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="modalDiaChiKhachHangLabel">Danh S√°ch ƒê·ªãa Ch·ªâ</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <!-- N√∫t th√™m ƒë·ªãa ch·ªâ b√™n ngo√†i b·∫£ng -->
                                    <button class="btn btn-success" onclick="openAddDiaChiModal()">Th√™m ƒê·ªãa Ch·ªâ</button>
                                    <table id="productTable1" class="table table-striped table-bordered">
                                        <thead class="table-dark">
                                        <tr>
                                            <th class="text-center">#</th>
                                            <th class="text-center">ƒê·ªãa Ch·ªâ C·ª• Th·ªÉ</th>
                                            <th class="text-center">Ph∆∞·ªùng</th>
                                            <th class="text-center">Huy·ªán</th>
                                            <th class="text-center">Th√†nh Ph·ªë</th>
                                            <th class="text-center">Tr·∫°ng Th√°i</th>
                                            <th class="text-center">H√†nh ƒê·ªông</th>
                                        </tr>
                                        </thead>
                                        <tbody id="diaChiBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Th√™m/Ch·ªânh S·ª≠a ƒê·ªãa Ch·ªâ -->
                    <div class="modal fade" id="modalDiaChi" tabindex="-1" aria-labelledby="modalDiaChiLabel"
                         aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="modalDiaChiLabel">Th√™m/Ch·ªânh S·ª≠a ƒê·ªãa Ch·ªâ</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <input type="hidden" id="idKhachHang">
                                    <input type="hidden" id="idDiaChi">
                                    <div class="mb-3">
                                        <label class="form-label">ƒê·ªãa ch·ªâ c·ª• th·ªÉ</label>
                                        <input type="text" class="form-control" id="diaChiCuThe">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Th√†nh Ph·ªë</label>
                                        <select class="form-select" id="thanhPho">
                                            <option value="">Ch·ªçn T·ªânh/Th√†nh ph·ªë</option>
                                        </select>
                                        <input type="hidden" id="thanhPhoHidden">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Huy·ªán</label>
                                        <select class="form-select" id="huyen">
                                            <option value="">Ch·ªçn Qu·∫≠n/Huy·ªán</option>
                                        </select>
                                        <input type="hidden" id="huyenHidden">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Ph∆∞·ªùng</label>
                                        <select class="form-select" id="phuong">
                                            <option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>
                                        </select>
                                        <input type="hidden" id="phuongHidden">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                                    <button type="button" id="saveDiaChiButton" class="btn btn-success"
                                            onclick="saveDiaChi()">L∆∞u
                                    </button>
                                    <button type="button" id="updateDiaChiButton" class="btn btn-primary d-none"
                                            onclick="updateDiaChi()">C·∫≠p Nh·∫≠t
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.box -->

        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->

    <div th:replace="admin/fragments/footer :: footer"></div>


</div>
<!-- ./wrapper -->

<!-- jQuery 3 -->

<div th:replace="admin/fragments/script :: script"></div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // H√†m chuy·ªÉn ƒë·ªïi ng√†y sang ƒë·ªãnh d·∫°ng Vi·ªát Nam (dd/MM/yyyy)
        function formatDate(dateString) {
            if (!dateString) return "";
            const date = new Date(dateString);
            return date.toLocaleDateString("vi-VN", {
                day: "2-digit",
                month: "2-digit",
                year: "numeric"
            });
        }

        function renderKhachHang(data) {
            if (!Array.isArray(data)) {
                console.error("D·ªØ li·ªáu kh√¥ng ph·∫£i l√† m·∫£ng:", data);
                return;
            }

            const tbody = document.getElementById('khachHangBody');
            tbody.innerHTML = "";

            data.forEach((khachHang, index) => {
                if (!khachHang || typeof khachHang !== "object") return; // Ki·ªÉm tra d·ªØ li·ªáu h·ª£p l·ªá

                const row = document.createElement('tr');
                row.innerHTML = `
            <td class="text-center">${index + 1}</td>
            <td class="text-center"><img src="${khachHang.hinhAnh || ''}" alt="·∫¢nh" width="50"></td>
            <td class="text-center">${khachHang.hoTen || 'N/A'}</td>
            <td class="text-center">${khachHang.soDienThoai || 'N/A'}</td>
            <td class="text-center">${formatDate(khachHang.ngaySinh) || 'N/A'}</td>
            <td class="text-center">${khachHang.gioiTinh ? "Nam" : "N·ªØ"}</td>
            <td class="text-center">${khachHang.trangThai || 'N/A'}</td>
            <td class="text-center">
                <button class="btn btn-primary" onclick="editKhachHang(${khachHang.id})">S·ª≠a</button>
                <button class="btn btn-primary" onclick="diaChiKhachHang(${khachHang.id})">ƒê·ªãa Ch·ªâ</button>
            </td>
        `;
                tbody.appendChild(row);
            });
        }

        fetch('http://localhost:8080/api/khach-hang/list')
            .then(response => response.text()) // L·∫•y d·ªØ li·ªáu d·∫°ng text ƒë·ªÉ debug
            .then(text => {
                try {
                    const data = JSON.parse(text); // Ki·ªÉm tra JSON h·ª£p l·ªá
                    renderKhachHang(data);
                } catch (error) {
                    console.error("L·ªói khi parse JSON:", error, text);
                }
            })
            .catch(error => console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error));
    });

    function previewImage(event) {
        const input = event.target;
        const preview = document.getElementById('avatarPreview');
        const preview1 = document.getElementById('avatarPreview1');

        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                if (preview) preview.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }

        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                if (preview1) preview1.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function openModalForAdd() {
        // X√≥a d·ªØ li·ªáu c≈© trong form
        document.querySelector('#modalUpdateKhachHang input[name="hoTen"]').value = "";
        document.querySelector('#modalUpdateKhachHang input[name="username"]').value = "";
        document.querySelector('#modalUpdateKhachHang input[name="email"]').value = "";
        document.querySelector('#modalUpdateKhachHang input[name="soDienThoai"]').value = "";
        document.querySelector('#modalUpdateKhachHang select[name="gioiTinh"]').value = "true";
        document.querySelector('#modalUpdateKhachHang input[name="ngaySinh"]').value = "";
        document.querySelector('#modalUpdateKhachHang select[name="trangThai"]').value = "ƒêang Ho·∫°t ƒê·ªông";
        document.querySelector('#modalUpdateKhachHang img#avatarPreview1').src = "";
        document.querySelector('#modalUpdateKhachHang #khachHangId').value = ""; // ƒê·∫∑t ID r·ªóng ƒë·ªÉ bi·∫øt l√† th√™m m·ªõi

        // Hi·ªÉn th·ªã n√∫t "L∆∞u" v√† ·∫©n n√∫t "C·∫≠p Nh·∫≠t"
        document.getElementById("btnSave").classList.remove("d-none");
        document.getElementById("btnUpdate").classList.add("d-none");

        // M·ªü modal
        new bootstrap.Modal(document.getElementById('modalUpdateKhachHang')).show();
    }

    // H√†m m·ªü modal v√† ƒëi·ªÅn th√¥ng tin nh√¢n vi√™n v√†o form
    function editKhachHang(id) {
        // G·ªçi API ƒë·ªÉ l·∫•y th√¥ng tin kh√°ch h√†ng
        fetch(`http://localhost:8080/api/khach-hang/${id}`)
            .then(response => response.json())
            .then(khachHang => {
                // ƒêi·ªÅn th√¥ng tin kh√°ch h√†ng v√†o form
                document.querySelector('#modalUpdateKhachHang input[name="hoTen"]').value = khachHang.hoTen;
                document.querySelector('#modalUpdateKhachHang input[name="username"]').value = khachHang.username;
                document.querySelector('#modalUpdateKhachHang input[name="email"]').value = khachHang.email;
                document.querySelector('#modalUpdateKhachHang input[name="soDienThoai"]').value = khachHang.soDienThoai;
                document.querySelector('#modalUpdateKhachHang select[name="gioiTinh"]').value = khachHang.gioiTinh ? "true" : "false";
                document.querySelector('#modalUpdateKhachHang input[name="ngaySinh"]').value = khachHang.ngaySinh;
                document.querySelector('#modalUpdateKhachHang select[name="trangThai"]').value = khachHang.trangThai;
                document.querySelector('#modalUpdateKhachHang img#avatarPreview1').src = khachHang.hinhAnh;
                document.querySelector('#modalUpdateKhachHang #khachHangId').value = khachHang.id;


                // ·∫®n n√∫t "L∆∞u" v√† hi·ªÉn th·ªã n√∫t "C·∫≠p Nh·∫≠t"
                document.getElementById("btnSave").classList.add("d-none");
                document.getElementById("btnUpdate").classList.remove("d-none");

                // G·ªçi API ƒë·ªÉ l·∫•y ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh c·ªßa kh√°ch h√†ng
                loadDiaChiMacDinh(id);

                // M·ªü modal
                new bootstrap.Modal(document.getElementById('modalUpdateKhachHang')).show();
            })
            .catch(error => console.error('L·ªói khi t·∫£i th√¥ng tin kh√°ch h√†ng:', error));
    }

    function loadDiaChiMacDinh(id) {
        fetch(`http://localhost:8080/api/khach-hang/${id}/dia-chi-mac-dinh`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh");
                }
                return response.json();
            })
            .then(data => {
                document.querySelector('#modalUpdateKhachHang input[name="diaChi"]').value =
                    `${data.diaChiCuThe}, ${data.phuong}, ${data.huyen}, ${data.thanhPho}`;
            })
            .catch(error => {
                console.error("L·ªói khi l·∫•y ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh:", error);
                // Kh√¥ng hi·ªÉn th·ªã th√¥ng b√°o
            });
    }

   function showFieldError(fieldName, message) {
            const field = document.querySelector(`[name="${fieldName}"]`);
            const errorDiv = document.querySelector(`#error-${fieldName}`);

            if (field) field.classList.add("is-invalid");
            if (errorDiv) {
                errorDiv.innerText = message;
                errorDiv.style.display = "block";
            }
        }

        function clearAllErrors() {
            document.querySelectorAll(".is-invalid").forEach(el => el.classList.remove("is-invalid"));
            document.querySelectorAll(".invalid-feedback").forEach(el => {
                el.innerText = "";
                el.style.display = "none";
            });
        }

        async function saveKhachHang() {
            const btnSubmit = document.getElementById("btnSave");
            if (!btnSubmit) return;

            btnSubmit.disabled = true;
            btnSubmit.innerHTML = `<i class="bi bi-hourglass-split"></i> ƒêang x·ª≠ l√Ω...`;

            clearAllErrors();

            const formData = new FormData();

            function getValue(name) {
                const element = document.querySelector(`[name="${name}"]`);
                return element ? element.value.trim() : "";
            }

            formData.append("hoTen", getValue("hoTen"));
            formData.append("username", getValue("username"));
            formData.append("password", getValue("password"));
            formData.append("email", getValue("email"));
            formData.append("soDienThoai", getValue("soDienThoai"));
            formData.append("gioiTinh", getValue("gioiTinh") === "true");
            formData.append("ngaySinh", getValue("ngaySinh"));
            formData.append("trangThai", getValue("trangThai"));

            const fileInput = document.querySelector('[name="hinhAnh"]');
            if (fileInput && fileInput.files.length > 0) {
                formData.append("file", fileInput.files[0]);
            }

            try {
                const response = await fetch("http://localhost:8080/api/khach-hang/add", {
                    method: "POST",
                    body: formData
                });

                const responseData = await response.json();

                if (responseData.status === "warning") {
                    for (const [field, msg] of Object.entries(responseData.messages)) {
                        showFieldError(field, msg);
                    }

                    await Swal.fire({
                        title: "Th√¥ng tin ch∆∞a h·ª£p l·ªá!",
                        text: "Vui l√≤ng ki·ªÉm tra l·∫°i c√°c tr∆∞·ªùng ƒë∆∞·ª£c ƒë√°nh d·∫•u.",
                        icon: "warning",
                        confirmButtonText: "OK"
                    });

                    return;
                }

                if (responseData.status !== "success") {
                    throw new Error(responseData.message || "C√≥ l·ªói x·∫£y ra khi th√™m kh√°ch h√†ng.");
                }

                await Swal.fire({
                    title: "Th√†nh c√¥ng!",
                    text: "Kh√°ch h√†ng ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng!",
                    icon: "success",
                    confirmButtonText: "OK"
                });

                setTimeout(() => location.reload(), 1500);

            } catch (error) {
                Swal.fire({
                    title: "L·ªói!",
                    text: error.message,
                    icon: "error",
                    confirmButtonText: "Th·ª≠ l·∫°i"
                });
            } finally {
                setTimeout(() => {
                    btnSubmit.disabled = false;
                    btnSubmit.innerHTML = `Th√™m kh√°ch h√†ng`;
                }, 1500);
            }
        }


   async function updateKhachHang() {
    const btnSubmit = document.getElementById("btnUpdate");
    const form = document.getElementById('updateKhachHangForm');
    if (!btnSubmit || !form) return;

    btnSubmit.disabled = true;
    btnSubmit.innerHTML = `<i class="bi bi-hourglass-split"></i> ƒêang x·ª≠ l√Ω...`;

    // Clear l·ªói c≈© n·∫øu c√≥
    clearAllErrors();

    const updatedKhachHang = {
        id: form.querySelector('input[name="id"]').value,
        hoTen: form.querySelector('input[name="hoTen"]').value.trim(),
        username: form.querySelector('input[name="username"]').value.trim(),
        email: form.querySelector('input[name="email"]').value.trim(),
        soDienThoai: form.querySelector('input[name="soDienThoai"]').value.trim(),
        gioiTinh: form.querySelector('select[name="gioiTinh"]').value === "true",
        ngaySinh: form.querySelector('input[name="ngaySinh"]').value,
        trangThai: form.querySelector('select[name="trangThai"]').value,
        password: form.querySelector('input[name="password"]').value
    };

    const formData = new FormData();
    for (const [key, value] of Object.entries(updatedKhachHang)) {
        formData.append(key, value);
    }

    const fileInput = form.querySelector('input[name="hinhAnh"]');
    if (fileInput.files && fileInput.files[0]) {
        formData.append('file', fileInput.files[0]);
    }

    try {
        const response = await fetch(`http://localhost:8080/api/khach-hang/update/${updatedKhachHang.id}`, {
            method: 'PUT',
            body: formData
        });

        const responseData = await response.json();

        if (responseData.status === "warning") {
            for (const [field, msg] of Object.entries(responseData.messages)) {
                showFieldError(field, msg);
            }

            await Swal.fire({
                title: "Th√¥ng tin ch∆∞a h·ª£p l·ªá!",
                text: "Vui l√≤ng ki·ªÉm tra l·∫°i c√°c tr∆∞·ªùng ƒë∆∞·ª£c ƒë√°nh d·∫•u.",
                icon: "warning",
                confirmButtonText: "OK"
            });

            return;
        }

        if (responseData.status !== "success") {
            throw new Error(responseData.message || "C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t kh√°ch h√†ng.");
        }

        await Swal.fire({
            title: "C·∫≠p nh·∫≠t th√†nh c√¥ng!",
            text: "Th√¥ng tin kh√°ch h√†ng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.",
            icon: "success",
            confirmButtonText: "OK"
        });

        setTimeout(() => location.reload(), 1500);

    } catch (error) {
        console.error("L·ªói x·∫£y ra:", error);
        Swal.fire({
            title: "L·ªói!",
            text: error.message,
            icon: "error",
            confirmButtonText: "Th·ª≠ l·∫°i"
        });
    } finally {
        btnSubmit.disabled = false;
        btnSubmit.innerHTML = `C·∫≠p nh·∫≠t Kh√°ch H√†ng`;
    }
}

    function showFieldError(fieldName, message) {
    const field = document.querySelector(`[name="${fieldName}"]`);
    const errorDiv = document.querySelector(`#error-${fieldName}`);

    if (field) field.classList.add("is-invalid");
    if (errorDiv) {
        errorDiv.innerText = message;
        errorDiv.style.display = "block";
    }
}

function clearAllErrors() {
    document.querySelectorAll(".is-invalid").forEach(el => el.classList.remove("is-invalid"));
    document.querySelectorAll(".invalid-feedback").forEach(el => {
        el.innerText = "";
        el.style.display = "none";
    });
}


</script>
<script>
    document.addEventListener("focusin", function (event) {
        let ancestor = document.querySelector(".wrapper[aria-hidden='true']");
        if (ancestor && ancestor.contains(event.target)) {
            ancestor.removeAttribute("aria-hidden");
        }
    });
</script>
<script>
    let currentKhachHangId = null; // Khai b√°o bi·∫øn to√†n c·ª•c

    function diaChiKhachHang(id) {
        currentKhachHangId = id;

        fetch(`http://localhost:8080/api/khach-hang/dia-chi/${id}`)
            .then(response => response.ok ? response.json() : [])
            .then(data => {
                const tbody = document.getElementById('diaChiBody');
                tbody.innerHTML = "";

                if (!Array.isArray(data) || data.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='8' class='text-center'>Kh√¥ng c√≥ ƒë·ªãa ch·ªâ n√†o.</td></tr>";
                } else {
                    data.forEach((diaChi, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td class="text-center">${index + 1}</td>
                        <td class="text-center">${diaChi.diaChiCuThe || 'N/A'}</td>
                        <td class="text-center">${diaChi.phuong || 'N/A'}</td>
                        <td class="text-center">${diaChi.huyen || 'N/A'}</td>
                        <td class="text-center">${diaChi.thanhPho || 'N/A'}</td>
                        <td class="text-center align-middle">
                            <div class="d-flex justify-content-center">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch"
                                        ${diaChi.trangThai === 'M·∫∑c ƒê·ªãnh' ? 'checked' : ''}
                                        onchange="updateTrangThai(${diaChi.id}, this.checked)">
                                </div>
                            </div>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-primary" onclick="editDiaChi(${diaChi.id})">S·ª≠a</button>
                            <button class="btn btn-danger" onclick="deleteDiaChi(${diaChi.id})">X√≥a</button>
                        </td>
                    `;
                        tbody.appendChild(row);
                    });
                }

                // M·ªü modal ch·ª©a form danh s√°ch ƒë·ªãa ch·ªâ v√† n√∫t th√™m ƒë·ªãa ch·ªâ
                new bootstrap.Modal(document.getElementById('modalDiaChiKhachHang')).show();
            })
            .catch(error => console.error('L·ªói khi t·∫£i danh s√°ch ƒë·ªãa ch·ªâ:', error));
    }

    function updateTrangThai(id, isChecked) {
        fetch(`http://localhost:8080/api/khach-hang/dia-chi/${id}/trang-thai`, {
            method: "PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({trangThai: isChecked ? "M·∫∑c ƒê·ªãnh" : "Kh√¥ng M·∫∑c ƒê·ªãnh"})
        })
            .then(response => response.text()) // ƒê·ªçc d·ªØ li·ªáu d∆∞·ªõi d·∫°ng text
            .then(text => {
                console.log("Server Response:", text); // Ki·ªÉm tra ph·∫£n h·ªìi t·ª´ server
                if (text.includes("th√†nh c√¥ng")) { // Ki·ªÉm tra n·∫øu ph·∫£n h·ªìi c√≥ ch·ª©a "th√†nh c√¥ng"
                    Swal.fire({
                        icon: "success",
                        title: "Th√†nh c√¥ng!",
                        text: "C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë·ªãa ch·ªâ th√†nh c√¥ng.",
                        timer: 1500,
                        showConfirmButton: false
                    });
                    reloadDiaChiBody(); // C·∫≠p nh·∫≠t l·∫°i danh s√°ch ƒë·ªãa ch·ªâ
                } else {
                    throw new Error("Ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá!");
                }
            })
            .catch(error => {
                console.error('L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i:', error);
                Swal.fire({
                    icon: "error",
                    title: "L·ªói!",
                    text: "ƒê√£ x·∫£y ra l·ªói trong qu√° tr√¨nh c·∫≠p nh·∫≠t.",
                });
            });
    }

    // H√†m ch·ªâ c·∫≠p nh·∫≠t ph·∫ßn th√¢n tbody
    function reloadDiaChiBody() {
        if (!currentKhachHangId) {
            console.error('L·ªói: currentKhachHangId ch∆∞a ƒë∆∞·ª£c g√°n gi√° tr·ªã.');
            return;
        }

        fetch(`http://localhost:8080/api/khach-hang/dia-chi/${currentKhachHangId}`)
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('diaChiBody');
                tbody.innerHTML = "";

                if (!Array.isArray(data) || data.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='8' class='text-center'>Kh√¥ng c√≥ ƒë·ªãa ch·ªâ n√†o.</td></tr>";
                } else {
                    data.forEach((diaChi, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td class="text-center">${index + 1}</td>
                        <td class="text-center">${diaChi.diaChiCuThe || 'N/A'}</td>
                        <td class="text-center">${diaChi.phuong || 'N/A'}</td>
                        <td class="text-center">${diaChi.huyen || 'N/A'}</td>
                        <td class="text-center">${diaChi.thanhPho || 'N/A'}</td>
                        <td class="text-center align-middle">
                            <div class="d-flex justify-content-center">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch"
                                        ${diaChi.trangThai === 'M·∫∑c ƒê·ªãnh' ? 'checked' : ''}
                                        onchange="updateTrangThai(${diaChi.id}, this.checked)">
                                </div>
                            </div>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-primary" onclick="editDiaChi(${diaChi.id})">S·ª≠a</button>
                            <button class="btn btn-danger" onclick="deleteDiaChi(${diaChi.id})">X√≥a</button>
                        </td>
                    `;
                        tbody.appendChild(row);
                    });
                }
            })
            .catch(error => console.error('L·ªói khi t·∫£i danh s√°ch ƒë·ªãa ch·ªâ:', error));
    }

    // M·ªü modal th√™m ƒë·ªãa ch·ªâ (thi·∫øt l·∫≠p ch·∫ø ƒë·ªô th√™m m·ªõi)
    function openAddDiaChiModal() {
        document.getElementById("modalDiaChiLabel").textContent = "Th√™m ƒê·ªãa Ch·ªâ";
        document.getElementById("diaChiCuThe").value = "";
        document.getElementById("phuong").value = "";
        document.getElementById("huyen").value = "";
        document.getElementById("thanhPho").value = "";
        document.getElementById("idDiaChi").value = "";
        document.getElementById("idKhachHang").value = currentKhachHangId;  // ƒê·∫£m b·∫£o currentKhachHangId ƒë∆∞·ª£c g√°n v√†o tr∆∞·ªùng n√†y

        document.getElementById("thanhPhoHidden").value = "";
        document.getElementById("huyenHidden").value = "";
        document.getElementById("phuongHidden").value = "";


        // ·∫®n n√∫t "C·∫≠p Nh·∫≠t" v√† hi·ªÉn th·ªã n√∫t "L∆∞u"
        document.getElementById("saveDiaChiButton").classList.remove("d-none");
        document.getElementById("updateDiaChiButton").classList.add("d-none");

        // M·ªü modal
        new bootstrap.Modal(document.getElementById("modalDiaChi")).show();
    }

    // Th√™m m·ªõi ƒë·ªãa ch·ªâ
    function saveDiaChi() {
        const diaChiCuThe = document.getElementById("diaChiCuThe").value.trim();
        const phuong = document.getElementById("phuong").value.trim();
        const huyen = document.getElementById("huyen").value.trim();
        const thanhPho = document.getElementById("thanhPho").value.trim();
        const khachHangId = document.getElementById("idKhachHang").value.trim();

        if (!khachHangId) {
            Swal.fire("L·ªói!", "Kh√°ch h√†ng kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.", "error");
            return;
        }

        // Ki·ªÉm tra c√°c tr∆∞·ªùng c·∫ßn thi·∫øt
        if (!diaChiCuThe || !phuong || !huyen || !thanhPho) {
            Swal.fire("L·ªói!", "Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªãa ch·ªâ.", "error");
            return;
        }

        const diaChi = {
            diaChiCuThe,
            phuong,
            huyen,
            thanhPho
        };

        console.log("D·ªØ li·ªáu g·ª≠i l√™n API:", JSON.stringify(diaChi, null, 2));

        // Thay ƒë·ªïi ƒë∆∞·ªùng d·∫´n API v·ªõi idKhachHang l√†m tham s·ªë URL
        fetch(`http://localhost:8080/api/dia-chi/add?idKhachHang=${khachHangId}`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(diaChi)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("L·ªói khi g·ª≠i d·ªØ li·ªáu!");
                }
                return response.json();
            })
            .then(data => {
                console.log("Ph·∫£n h·ªìi t·ª´ server:", data);
                Swal.fire("Th√†nh c√¥ng!", "ƒê√£ th√™m ƒë·ªãa ch·ªâ.", "success");
                reloadDiaChiBody();  // Gi·∫£ s·ª≠ b·∫°n c√≥ h√†m reloadDiaChiBody() ƒë·ªÉ l√†m m·ªõi danh s√°ch ƒë·ªãa ch·ªâ
                bootstrap.Modal.getInstance(document.getElementById("modalDiaChi")).hide();
            })
            .catch(error => {
                console.error("L·ªói khi th√™m ƒë·ªãa ch·ªâ:", error);
                Swal.fire("L·ªói!", "Kh√¥ng th·ªÉ th√™m ƒë·ªãa ch·ªâ.", "error");
            });
    }

    // M·ªü modal ch·ªânh s·ª≠a ƒë·ªãa ch·ªâ
    function editDiaChi(idDiaChi) {
        console.log("ID ƒê·ªãa Ch·ªâ c·∫ßn s·ª≠a:", idDiaChi);  // Ki·ªÉm tra ID tr∆∞·ªõc khi g·ª≠i API
        fetch(`http://localhost:8080/api/dia-chi/${idDiaChi}`)
            .then(response => response.json())
            .then(data => {
                console.log("D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:", data);

                document.getElementById("modalDiaChiLabel").textContent = "Ch·ªânh S·ª≠a ƒê·ªãa Ch·ªâ";
                document.getElementById("diaChiCuThe").value = data.diaChiCuThe || "";
                document.getElementById("thanhPho").value = data.thanhPho || "";
                document.getElementById("idDiaChi").value = idDiaChi;

                // G√°n gi√° tr·ªã cho select huy·ªán
                const huyenSelect = document.getElementById("huyen");
                huyenSelect.innerHTML = ""; // X√≥a c√°c option c≈©
                if (data.huyen) {
                    const huyenOption = new Option(data.huyen, data.huyen);
                    huyenSelect.add(huyenOption);
                    huyenSelect.value = data.huyen;
                }

                // G√°n gi√° tr·ªã cho select ph∆∞·ªùng
                const phuongSelect = document.getElementById("phuong");
                phuongSelect.innerHTML = ""; // X√≥a c√°c option c≈©
                if (data.phuong) {
                    const phuongOption = new Option(data.phuong, data.phuong);
                    phuongSelect.add(phuongOption);
                    phuongSelect.value = data.phuong;
                }

                // Ki·ªÉm tra v√† g√°n gi√° tr·ªã kh√°ch h√†ng ID n·∫øu c√≥
                if (data.khachHangId) {
                    document.getElementById("khachHangId").value = data.khachHangId;
                }

                // Hi·ªÉn th·ªã n√∫t "C·∫≠p Nh·∫≠t", ·∫©n n√∫t "L∆∞u"
                document.getElementById("saveDiaChiButton").classList.add("d-none");
                document.getElementById("updateDiaChiButton").classList.remove("d-none");

                // Hi·ªÉn th·ªã modal
                new bootstrap.Modal(document.getElementById("modalDiaChi")).show();
            })
            .catch(error => console.error("L·ªói khi t·∫£i d·ªØ li·ªáu ƒë·ªãa ch·ªâ:", error));
    }

    // C·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ
    function updateDiaChi() {
        const idDiaChi = document.getElementById("idDiaChi").value;
        console.log("ID g·ª≠i l√™n API c·∫≠p nh·∫≠t:", idDiaChi); // Ki·ªÉm tra ID tr∆∞·ªõc khi g·ª≠i

        const diaChi = {
            diaChiCuThe: document.getElementById("diaChiCuThe").value,
            phuong: document.getElementById("phuong").value,
            huyen: document.getElementById("huyen").value,
            thanhPho: document.getElementById("thanhPho").value
        };

        fetch(`http://localhost:8080/api/dia-chi/${idDiaChi}`, {
            method: "PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(diaChi)
        })
            .then(response => response.text()) // L·∫•y ph·∫£n h·ªìi d·∫°ng text
            .then(text => {
                try {
                    const data = JSON.parse(text); // Th·ª≠ chuy·ªÉn ƒë·ªïi th√†nh JSON
                    console.log("Ph·∫£n h·ªìi t·ª´ server:", data);
                    Swal.fire("Th√†nh c√¥ng!", "ƒê√£ c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ.", "success");
                } catch (error) {
                    console.log("Ph·∫£n h·ªìi kh√¥ng ph·∫£i JSON:", text);
                    Swal.fire("Th√†nh c√¥ng!", text, "success");
                }
                // ƒê√≥ng modal sau khi c·∫≠p nh·∫≠t
                const modal = bootstrap.Modal.getInstance(document.getElementById("modalDiaChi"));
                if (modal) modal.hide();
                reloadDiaChiBody(); // L√†m m·ªõi danh s√°ch sau khi c·∫≠p nh·∫≠t
            })
            .catch(error => {
                console.error("L·ªói khi c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ:", error);
                Swal.fire("L·ªói!", "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ.", "error");
            });
    }

    function deleteDiaChi(id) {
        Swal.fire({
            title: "B·∫°n c√≥ ch·∫Øc ch·∫Øn?",
            text: "B·∫°n c√≥ mu·ªën x√≥a ƒë·ªãa ch·ªâ n√†y kh√¥ng?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "C√≥, x√≥a ngay!",
            cancelButtonText: "H·ªßy",
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`http://localhost:8080/api/dia-chi/${id}`, {
                    method: "DELETE",
                })
                    .then(response => response.text()) // L·∫•y ph·∫£n h·ªìi d·∫°ng text
                    .then(text => {
                        try {
                            const data = JSON.parse(text); // Th·ª≠ chuy·ªÉn ƒë·ªïi th√†nh JSON
                            console.log("Ph·∫£n h·ªìi t·ª´ server:", data);
                            Swal.fire("Th√†nh c√¥ng!", "ƒê√£ x√≥a ƒë·ªãa ch·ªâ.", "success");
                        } catch (error) {
                            console.log("Ph·∫£n h·ªìi kh√¥ng ph·∫£i JSON:", text);
                            Swal.fire("Th√†nh c√¥ng!", text, "success");
                        }

                        // ƒê√≥ng modal n·∫øu ƒëang m·ªü
                        const modal = bootstrap.Modal.getInstance(document.getElementById("modalDiaChi"));
                        if (modal) modal.hide();

                        // L√†m m·ªõi danh s√°ch
                        reloadDiaChiBody();
                    })
                    .catch(error => {
                        console.error("L·ªói khi x√≥a ƒë·ªãa ch·ªâ:", error);
                        Swal.fire("L·ªói!", "Kh√¥ng th·ªÉ x√≥a ƒë·ªãa ch·ªâ. Vui l√≤ng th·ª≠ l·∫°i sau.", "error");
                    });
            }
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
    const thanhPhoSelect = document.getElementById("thanhPho");
    const huyenSelect = document.getElementById("huyen");
    const phuongSelect = document.getElementById("phuong");

    const thanhPhoHidden = document.getElementById("thanhPhoHidden");
    const huyenHidden = document.getElementById("huyenHidden");
    const phuongHidden = document.getElementById("phuongHidden");

    // Load danh s√°ch t·ªânh/th√†nh ph·ªë
    async function fetchProvinces(selectedValue = "") {
        try {
            let response = await fetch("https://provinces.open-api.vn/api/p/");
            let data = await response.json();

            thanhPhoSelect.innerHTML = '<option value="">Ch·ªçn T·ªânh/Th√†nh ph·ªë</option>';
            let selectedProvinceCode = "";

            data.forEach(province => {
                const selected = province.name === selectedValue ? "selected" : "";
                if (selected) selectedProvinceCode = province.code;
                thanhPhoSelect.innerHTML += `<option value="${province.name}" data-code="${province.code}" ${selected}>${province.name}</option>`;
            });

            if (selectedProvinceCode) {
                fetchDistricts(selectedProvinceCode, huyenHidden.value);
            }
        } catch (error) {
            console.error("L·ªói khi l·∫•y danh s√°ch t·ªânh/th√†nh ph·ªë:", error);
        }
    }

    // Load danh s√°ch qu·∫≠n/huy·ªán d·ª±a tr√™n t·ªânh
    async function fetchDistricts(provinceCode, selectedValue = "") {
        try {
            let response = await fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`);
            let data = await response.json();

            huyenSelect.innerHTML = '<option value="">Ch·ªçn Qu·∫≠n/Huy·ªán</option>';
            let selectedDistrictCode = "";

            data.districts.forEach(district => {
                const selected = district.name === selectedValue ? "selected" : "";
                if (selected) selectedDistrictCode = district.code;
                huyenSelect.innerHTML += `<option value="${district.name}" data-code="${district.code}" ${selected}>${district.name}</option>`;
            });

            if (selectedDistrictCode) {
                fetchWards(selectedDistrictCode, phuongHidden.value);
            }
        } catch (error) {
            console.error("L·ªói khi l·∫•y danh s√°ch qu·∫≠n/huy·ªán:", error);
        }
    }

    // Load danh s√°ch ph∆∞·ªùng/x√£ d·ª±a tr√™n qu·∫≠n/huy·ªán
    async function fetchWards(districtCode, selectedValue = "") {
        try {
            let response = await fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`);
            let data = await response.json();

            phuongSelect.innerHTML = '<option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>';

            data.wards.forEach(ward => {
                const selected = ward.name === selectedValue ? "selected" : "";
                phuongSelect.innerHTML += `<option value="${ward.name}" ${selected}>${ward.name}</option>`;
            });
        } catch (error) {
            console.error("L·ªói khi l·∫•y danh s√°ch ph∆∞·ªùng/x√£:", error);
        }
    }

    // S·ª± ki·ªán khi ch·ªçn t·ªânh/th√†nh ph·ªë
    thanhPhoSelect.addEventListener("change", function () {
        const selectedOption = this.options[this.selectedIndex];
        const code = selectedOption.getAttribute("data-code") || "";
        thanhPhoHidden.value = this.value;
        huyenSelect.innerHTML = '<option value="">Ch·ªçn Qu·∫≠n/Huy·ªán</option>';
        phuongSelect.innerHTML = '<option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>';
        if (code) {
            fetchDistricts(code);
        }
    });

    // S·ª± ki·ªán khi ch·ªçn qu·∫≠n/huy·ªán
    huyenSelect.addEventListener("change", function () {
        const selectedOption = this.options[this.selectedIndex];
        const code = selectedOption.getAttribute("data-code") || "";
        huyenHidden.value = this.value;
        phuongSelect.innerHTML = '<option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>';
        if (code) {
            fetchWards(code);
        }
    });

    // S·ª± ki·ªán khi ch·ªçn ph∆∞·ªùng/x√£
    phuongSelect.addEventListener("change", function () {
        phuongHidden.value = this.value;
    });

    // G·ªçi khi trang load ƒë·ªÉ ƒëi·ªÅn l·∫°i n·∫øu c√≥ d·ªØ li·ªáu c≈©
    fetchProvinces(thanhPhoHidden.value);
});

</script>

<script>
    $(document).ready(function () {
        $('#productTable').DataTable({
            "paging": true,
            "lengthMenu": [5, 10, 20],
            "pageLength": 5,
            "autoWidth": false,
            "responsive": true,
            "language": {
                "sProcessing": "ƒêang x·ª≠ l√Ω...",
                "sLengthMenu": "Hi·ªÉn th·ªã _MENU_ d√≤ng",
                "sZeroRecords": "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu",
                "sInfo": "Hi·ªÉn th·ªã _START_ ƒë·∫øn _END_ trong t·ªïng _TOTAL_ d√≤ng",
                "sInfoEmpty": "Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã",
                "sInfoFiltered": "(l·ªçc t·ª´ _MAX_ d√≤ng)",
                "sSearch": "T√¨m ki·∫øm:",
                "oPaginate": {
                    "sFirst": "ƒê·∫ßu",
                    "sPrevious": "Tr∆∞·ªõc",
                    "sNext": "Ti·∫øp",
                    "sLast": "Cu·ªëi"
                }
            }
        });
    });
</script>
<script src="/js/main.js"></script>
<script src="/js/DangNhap/login.js"></script>
<script src="/js/DangNhap/logout.js"></script>
</body>
</html>
